{% extends "base.html" %}
{% block content %}
<br> 
<script src="https://d3js.org/d3.v4.min.js"></script>
<p> I thought it would be interesting to use some of the forum's metadata I scraped to profile the sites demographics and popularity. In the previous section, I noted that the 'average'
sentiment value tracked the 'male' average very closely. This led me to believe that the site was male dominated. Gender data is readily available in the forums metadata, so I thought I would
test this assumption.
</p>
<hr>
<b><p id="pie"></p></b>
<div class="dropdown">
    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    </button>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <a class="dropdown-item" onclick="updateData('aggregate')">Display aggregate data.</a>
        <a class="dropdown-item" onclick="updateData('ketamine')">Display ketamine data.</a>
        <a class="dropdown-item" onclick="updateData('LSD')">Display LSD data.</a>
        <a class="dropdown-item" onclick="updateData('cannabis')">Display cannabis data.</a>
        <a class="dropdown-item" onclick="updateData('amphetamines')">Display amphetamines data.</a>
        <a class="dropdown-item" onclick="updateData('mushrooms')">Display mushrooms data.</a>
        <a class="dropdown-item" onclick="updateData('cocaine')">Display cocaine data.</a>
        <a class="dropdown-item" onclick="updateData('MDMA')">Display MDMA data.</a>
    </div>
</div>
<svg viewBox="0 0 600 250"  preserveAspectRatio="xMidYMid meet" id="area1"></svg>
<hr>
<p>Indeed, the websites population (or at least active user base) is mostly male.</p>
<p>Poking around the Erowid site, you get the feeling that its population is dwindling. Perhaps it's the UI, but the site just feels like it's from another era. The forum posts list a date, and interestingly,
the view count for the forum post. I think that these two metrics, plotted side by side, are an effective metric detailing the sites decline. I'm unsure what took place in 2007 that resulted in such a spike in both
forum posts and forum views. Organic growth? Increase in advertisement spending? It's hard to say, but clearly Erowid was not able to retain that usage.
</p>
<hr>
<div class="container">
  <div class="row">
    <div class="col">
      <b><p id="posts"></p></b>
    </div>
    <div class="col">
      <b><p id="views"></p></b>
    </div>
  </div>
  <div class="row" id="buttonContainer">
    <div class="dropdown">
      <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <a class="dropdown-item" onclick="updateData2('aggregate')">Display aggregate data.</a>
        <a class="dropdown-item" onclick="updateData2('ketamine')">Display ketamine data.</a>
        <a class="dropdown-item" onclick="updateData2('LSD')">Display LSD data.</a>
        <a class="dropdown-item" onclick="updateData2('cannabis')">Display cannabis data.</a>
        <a class="dropdown-item" onclick="updateData2('amphetamines')">Display amphetamines data.</a>
        <a class="dropdown-item" onclick="updateData2('mushrooms')">Display mushrooms data.</a>
        <a class="dropdown-item" onclick="updateData2('cocaine')">Display cocaine data.</a>
        <a class="dropdown-item" onclick="updateData2('MDMA')">Display MDMA data.</a>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <svg class="graphContainer" viewBox="0 0 400 400"  preserveAspectRatio="xMidYMid meet" id="area2"> </svg>
    </div>
    <div class="col">
      <svg class="graphContainer" viewBox="0 0 400 400"  preserveAspectRatio="xMidYMid meet" id="area3"></svg>
    </div>
  </div>
</div>
<hr>


<p>I'd like to briefly reflect on this project and some of the issues, that, if I had known better, could of made this project easier to work with. The biggest issue was the scraper I wrote. It's funny to think about now, but when I wrote the scraper,
  I did not understanding the concept of database types. I pretty much stored in the backend as NVARCHAR type. This is not a good idea. Take for example these queries used to serve up the data via my Flask back-end.
</p>
<ul>
  <li>query = cur.execute("SELECT EXTRACT(YEAR from date::DATE) AS extracted_year, count(EXTRACT(YEAR from date::DATE)) FROM erowid.main WHERE EXTRACT(YEAR from date::DATE) NOT IN ('1969') GROUP BY extracted_year ORDER BY extracted_year;")</li>
  <li>query = cur.execute("SELECT EXTRACT(YEAR from date::DATE) AS extracted_year, sum(REPLACE(views,',','')::INT) FROM erowid.main WHERE EXTRACT(YEAR from date::DATE) NOT IN ('1969') GROUP BY extracted_year ORDER BY extracted_year;")</li>
</ul>
<p>Yikes. So dirty!</p>



<script>

var JSONdata = {{genders|tojson}}    
var genders = JSON.parse(JSONdata)
var JSONdata = {{genders_cannabis|tojson}}
var genders_cannabis = JSON.parse(JSONdata)
var JSONdata = {{genders_amphetamines|tojson}}
var genders_amphetamines = JSON.parse(JSONdata)
var JSONdata = {{genders_lsd|tojson}}
var genders_lsd = JSON.parse(JSONdata)
var JSONdata = {{genders_mushrooms|tojson}}
var genders_mushrooms = JSON.parse(JSONdata)
var JSONdata = {{genders_mdma|tojson}}
var genders_mdma = JSON.parse(JSONdata)
var JSONdata = {{genders_ketamine|tojson}}
var genders_ketamine = JSON.parse(JSONdata)
var JSONdata = {{genders_cocaine|tojson}}
var genders_cocaine = JSON.parse(JSONdata)

function updateData(val){
    if (val == 'aggregate'){
        d3.select("#first").remove()
        draw(genders,val)
    }
    if (val == 'cannabis'){
        d3.select("#first").remove()
        draw(genders_cannabis,val)
    }
    if (val == 'amphetamines'){
        d3.select("#first").remove()
        draw(genders_amphetamines,val)
    }
    if (val == 'LSD'){
        d3.select("#first").remove()
        draw(genders_lsd,val)
    }
    if (val == 'mushrooms'){
        d3.select("#first").remove()
        draw(genders_mushrooms,val)
    }
    if (val == 'ketamine'){
        d3.select("#first").remove()
        draw(genders_ketamine, val)
    }
    if (val == 'cocaine'){
        d3.select("#first").remove()
        draw(genders_cocaine, val)
    }
    if (val == 'MDMA'){
        d3.select("#first").remove()
        draw(genders_mdma, val)
    }
    if (val == "MDMA" || val == "LSD"){
                document.getElementById('pie').innerHTML = val + " Forum Post Authors by Gender"; 
            }
    else if (val == "aggregate"){
                document.getElementById('pie').innerHTML = "Forum Post Authors by Gender"    
    }
    else{
                document.getElementById('pie').innerHTML = val.charAt(0).toUpperCase() + val.slice(1) + " Forum Post Authors by Gender "; 
            }

    document.getElementById('dropdownMenuButton1').innerHTML = "Display " + val + " data.";
 
}

function draw(data,set){

  var margin = {top: 0, right:200, bottom:0, left:0},
          width = 600 - margin.left - margin.right,
          height = 250 - margin.top - margin.bottom,
          radius = Math.min(width, height) / 2;

  var svg = d3.select("#area1").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .attr("id", "first")
        .attr("radius", radius)

  var g = svg.append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

  var color = d3.scaleOrdinal(["lightpink", "steelblue", "grey"]);

  var pie = d3.pie()
      .sort(null)
      .value(function(d) { return d.count; });

  var path = d3.arc()
      .outerRadius(radius - 7.5)
      .innerRadius(0);

  var label = d3.arc()
      .outerRadius(radius - 35)
      .innerRadius(radius - 35);

  var arc = g.selectAll(".arc")
  .data(pie(data))
  .enter().append("g")
    .attr("class", "arc");

      arc.append("path")
        .attr("d", path)
        .attr("fill", function(d) { return color(d.data.gender); })
        .append("title")
            .text(function(d) { return d.data.gender+ ": " + Math.round(100*(d.data.count/(d.data.total)))+"%"; });


      arc.append("text")
        .attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
        .attr("dy", "0.35em")
        .text(function(d) { return d.data.gender; })

}
window.onload = updateData('aggregate')



var JSONdata = {{years|tojson}}    
var years = JSON.parse(JSONdata)
var JSONdata = {{years_cannabis|tojson}}
var years_cannabis = JSON.parse(JSONdata)
var JSONdata = {{years_amphetamines|tojson}}
var years_amphetamines = JSON.parse(JSONdata)
var JSONdata = {{years_lsd|tojson}}
var years_lsd = JSON.parse(JSONdata)
var JSONdata = {{years_mushrooms|tojson}}
var years_mushrooms = JSON.parse(JSONdata)
var JSONdata = {{years_mdma|tojson}}
var years_mdma = JSON.parse(JSONdata)
var JSONdata = {{years_ketamine|tojson}}
var years_ketamine = JSON.parse(JSONdata)
var JSONdata = {{years_cocaine|tojson}}
var years_cocaine = JSON.parse(JSONdata)

var JSONdata = {{views|tojson}}    
var views = JSON.parse(JSONdata)
var JSONdata = {{views_cannabis|tojson}}
var views_cannabis = JSON.parse(JSONdata)
var JSONdata = {{views_amphetamines|tojson}}
var views_amphetamines = JSON.parse(JSONdata)
var JSONdata = {{views_lsd|tojson}}
var views_lsd = JSON.parse(JSONdata)
var JSONdata = {{views_mushrooms|tojson}}
var views_mushrooms = JSON.parse(JSONdata)
var JSONdata = {{views_mdma|tojson}}
var views_mdma = JSON.parse(JSONdata)
var JSONdata = {{views_ketamine|tojson}}
var views_ketamine = JSON.parse(JSONdata)
var JSONdata = {{views_cocaine|tojson}}
var views_cocaine = JSON.parse(JSONdata)

function updateData2(val){
    if (val == 'aggregate'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views,years,val)
    }
    if (val == 'cannabis'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_cannabis,years_cannabis,val)
    }
    if (val == 'amphetamines'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_amphetamines,years_amphetamines,val)
    }
    if (val == 'LSD'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_lsd,years_lsd,val)
    }
    if (val == 'mushrooms'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_mushrooms,years_mushrooms,val)
    }
    if (val == 'ketamine'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_ketamine,years_ketamine,val)
    }
    if (val == 'cocaine'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_cocaine,years_cocaine,val)
    }
    if (val == 'MDMA'){
        d3.select("#second").remove()
        d3.select("#third").remove()
        draw2(views_mdma,years_mdma,val)
    }
    if (val == "MDMA" || val == "LSD"){
                document.getElementById('posts').innerHTML = val + " Forum Posts by Year"; 
                document.getElementById('views').innerHTML = val + " Forum Views by Year"; 

            }
    else if (val == "aggregate"){
                document.getElementById('posts').innerHTML = "Forum Posts by Year" 
                document.getElementById('views').innerHTML = "Forum Views by Year"    
   
    }
    else{
                document.getElementById('posts').innerHTML = val.charAt(0).toUpperCase() + val.slice(1) +  " Forum Posts by Year" 
                document.getElementById('views').innerHTML = val.charAt(0).toUpperCase() + val.slice(1) +  " Forum Views by Year" 
            }

    document.getElementById('dropdownMenuButton2').innerHTML = "Display " + val + " data.";
 
}
window.onload = updateData2('aggregate')


function draw2(viewData, yearData, set){

  var margin = {top: 20, right:0, bottom:30, left:60},
          width = 400 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom

  var svg = d3.select("#area2").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .attr("id", "second")

  var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
      y = d3.scaleLinear().rangeRound([height, 0]);

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
  yearData.forEach(function (d) {
        d.year = d.year;
        d.count = +d.count;
      });

  x.domain(yearData.map(function(d) { return d.year; }));
  y.domain([0, d3.max(yearData, function(d) { return d.count; })]);

  g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
          .style("text-anchor","end")
          .attr("dx", "-.5em")
          .attr("dy", ".6em")
          .attr("transform","rotate(-33)")


  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10))
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")

  g.selectAll(".bar")
    .data(yearData)
    .enter().append("rect")
      .attr("id","bar1")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.year); })
      .attr("y", function(d) { return y(d.count); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.count); })
      .append("title")
        .text(function(d) { return d.year+ ": " + d.count + " forum posts" });;


  var svg = d3.select("#area3").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .attr("id", "third")


  var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
      y = d3.scaleLinear().rangeRound([height, 0]);

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
  viewData.forEach(function (d) {
        d.year = d.year;
        d.views = +d.views;
      });

  x.domain(viewData.map(function(d) { return d.year; }));
  y.domain([0, d3.max(viewData, function(d) { return d.views; })]);

  g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
          .style("text-anchor","end")
          .attr("dx", "-.5em")
          .attr("dy", ".6em")
          .attr("transform","rotate(-33)")

  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10))

  g.selectAll(".bar")
    .data(viewData)
    .enter().append("rect")
      .attr("id","bar2")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.year); })
      .attr("y", function(d) { return y(d.views); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.views); })
      .append("title")
        .text(function(d) { 
            if (d.views > 1.0e+6){
                return d.year+ ": " + Math.round(10*d.views / 1.0e+6)/10 +"M forum views"
            }
            else{
                return d.year+": " + Math.round(10*d.views / 1.0e3)/10+"K forum views"
            }})

}


</script>

<style>

p {
  margin-bottom: .33em;
}

.graphContainer {
  float: left;
}

#bar1 {
  fill: #9B59B6;
  opacity:.75;
}

#bar1:hover {
  opacity:.9;
}

#bar2 {
  fill: #E74C3C;
  opacity:.75;
}

#bar2:hover {
  opacity:.9;
}

.axis--x path {
  display: none;
}

.arc path{
    opacity:.75;
}

.arc path:hover {
    opacity:1;
}

.arc text {
  font: 6px sans-serif;
  text-anchor: middle;
}

.arc path {
  stroke: #fff;
}

#buttonContainer{
  padding-left:1em
}
</style>

{% endblock %}