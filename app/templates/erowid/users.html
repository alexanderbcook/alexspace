{% extends "base.html" %}
{% block content %}
    <article>
        <header>
            <br>
                <hgroup>
                    <h4>Who Uses Erowid to Talk About Drugs?</h4>
                    <h5>A Look at Erowid's User Base</h5>
                </hgroup>
            <br>
        </header>
        <section>
          <p> I thought it would be interesting to use some of the forum's metadata I scraped to profile the sites demographics and popularity. In the previous section, I noted that the 'average' sentiment value tracked the 'male' average very closely. This led me to believe that the site was male dominated. Gender data is readily available in the forums metadata, so I thought I would test this assumption.
          </p>
        </section>
        <section>
          <hr>
          <h5 id="pie-title"></h5>
          <div class="dropdown">
              <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="pie-chart-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="dropdown-item" onclick="updateGenderData('aggregate')">Display aggregate data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('amphetamines')">Display amphetamines data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('cannabis')">Display cannabis data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('cocaine')">Display cocaine data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('ketamine')">Display ketamine data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('LSD')">Display LSD data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('mushrooms')">Display mushrooms data.</a>
                  <a class="dropdown-item" onclick="updateGenderData('MDMA')">Display MDMA data.</a>
              </div>
          </div>
          <svg viewBox="0 0 600 250"  preserveAspectRatio="xMidYMid meet" id="pie-chart-container"></svg>
          <hr>
        </section>
        <section>
          <p>Indeed, the websites population (or at least active user base) is mostly male. The most popular substances for female authors are MDMA and cocaine. I'm a little surprised that cannabis stories are so heavily male dominated, given the relative accessibility and popularity of the drug.</p>
          <p>Poking around the Erowid site, you get the feeling that its population is dwindling. Perhaps it's the UI, but the site just feels like it's from another era. The forum posts list a date, as well as the view count for the forum post, so I went ahead and plotted these metrics. I think that these two metrics, plotted side by side, are an effective metric detailing the sites rise and decline. 
          </p>
          <hr>
        </section>
        <section>
          <div class="container">
            <div class="row">
              <div class="col">
                <h5 id="post-title"></h5>
              </div>
              <div class="col">
                <h5 id="view-title"></h5>
              </div>
            </div>
            <div class="row" id="buttonContainer">
              <div class="dropdown">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="bar-chart-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="dropdown-item" onclick="updateSiteData('aggregate')">Display aggregate data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('amphetamines')">Display amphetamines data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('cannabis')">Display cannabis data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('cocaine')">Display cocaine data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('ketamine')">Display ketamine data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('LSD')">Display LSD data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('mushrooms')">Display mushrooms data.</a>
                  <a class="dropdown-item" onclick="updateSiteData('MDMA')">Display MDMA data.</a>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <svg class="graphContainer" viewBox="0 0 400 400"  preserveAspectRatio="xMidYMid meet" id="post-count-container"> </svg>
              </div>
              <div class="col">
                <svg class="graphContainer" viewBox="0 0 400 400"  preserveAspectRatio="xMidYMid meet" id="view-count-container"></svg>
              </div>
            </div>
          </div>
          <hr>
        </section>
        <section>
          <p>I'm unsure what took place in 2007 that resulted in such a spike in both forum posts and forum views. Organic growth? Increase in advertisement spending? It's hard to say, but clearly Erowid was not able to retain that usage.</p>
          <p>I'm quite pleased with the way this project turned out. I have many more ideas I'd like to explore with this dataset. I'm interested in plotting sentiment and dose size side by side. I imagine there is some correlation- specifically, I imagine after a certain dose size, sentiment trends downward rapidly. The barrier to this analysis is that the dose size is self-reported. In other words, how many grams is a 'hit' of cannabis or a 'a lot' of meth? Regardless, lots still to explore with this data.</p>
          <hr>
        </section>
      </article>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

document.getElementById('page-title').innerHTML = "Who Uses Erowid to Talk About Drugs?"    

var JSONdata = {{genders|tojson}}    
var genders = JSON.parse(JSONdata)
var JSONdata = {{genders_cannabis|tojson}}
var genders_cannabis = JSON.parse(JSONdata)
var JSONdata = {{genders_amphetamines|tojson}}
var genders_amphetamines = JSON.parse(JSONdata)
var JSONdata = {{genders_lsd|tojson}}
var genders_lsd = JSON.parse(JSONdata)
var JSONdata = {{genders_mushrooms|tojson}}
var genders_mushrooms = JSON.parse(JSONdata)
var JSONdata = {{genders_mdma|tojson}}
var genders_mdma = JSON.parse(JSONdata)
var JSONdata = {{genders_ketamine|tojson}}
var genders_ketamine = JSON.parse(JSONdata)
var JSONdata = {{genders_cocaine|tojson}}
var genders_cocaine = JSON.parse(JSONdata)

function updateGenderData(value){
    if (value == 'aggregate'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders, value)
    }
    if (value == 'cannabis'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_cannabis, value)
    }
    if (value == 'amphetamines'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_amphetamines, value)
    }
    if (value == 'LSD'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_lsd, value)
    }
    if (value == 'mushrooms'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_mushrooms, value)
    }
    if (value == 'ketamine'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_ketamine, value)
    }
    if (value == 'cocaine'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_cocaine, value)
    }
    if (value == 'MDMA'){
        d3.select("#pie-chart").remove()
        drawPieChart(genders_mdma, value)
    }
    if (value == "MDMA" || value == "LSD"){
      document.getElementById('pie-title').innerHTML = value + " Forum Post Authors by Gender"; 
    }
    else if (value == "aggregate"){
      document.getElementById('pie-title').innerHTML = "Forum Post Authors by Gender"    
    }
    else{
      document.getElementById('pie-title').innerHTML = value.charAt(0).toUpperCase() + value.slice(1) + " Forum Post Authors by Gender "; 
    }

    document.getElementById('pie-chart-dropdown').innerHTML = "Display " + value + " data.";
 
}

function drawPieChart(data,set){

  var margin = {top: 0, right:0, bottom:0, left:0},
          width = 600 - margin.left - margin.right,
          height = 250 - margin.top - margin.bottom,
          radius = Math.min(width, height) / 2;

  var svg = d3.select("#pie-chart-container").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .attr("id", "pie-chart")
        .attr("radius", radius)

  var g = svg.append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

  var color = d3.scaleOrdinal(["lightpink", "steelblue", "grey"]);

  var pie = d3.pie()
      .sort(null)
      .value(function(d) { return d.count; });

  var path = d3.arc()
      .outerRadius(radius - 7.5)
      .innerRadius(0);

  var label = d3.arc()
      .outerRadius(radius - 35)
      .innerRadius(radius - 35);

  var arc = g.selectAll(".arc")
  .data(pie(data))
  .enter().append("g")
    .attr("class", "arc");

      arc.append("path")
        .attr("d", path)
        .attr("fill", function(d) { return color(d.data.gender); })
        .append("title")
            .text(function(d) { return d.data.gender+ ": " + Math.round(100*(d.data.count/(d.data.total)))+"%"; });


      arc.append("text")
        .attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
        .attr("dy", "0.35em")
        .text(function(d) { return d.data.gender; })
}

window.onload = updateGenderData('aggregate')

var JSONdata = {{years|tojson}}    
var years = JSON.parse(JSONdata)
var JSONdata = {{years_cannabis|tojson}}
var years_cannabis = JSON.parse(JSONdata)
var JSONdata = {{years_amphetamines|tojson}}
var years_amphetamines = JSON.parse(JSONdata)
var JSONdata = {{years_lsd|tojson}}
var years_lsd = JSON.parse(JSONdata)
var JSONdata = {{years_mushrooms|tojson}}
var years_mushrooms = JSON.parse(JSONdata)
var JSONdata = {{years_mdma|tojson}}
var years_mdma = JSON.parse(JSONdata)
var JSONdata = {{years_ketamine|tojson}}
var years_ketamine = JSON.parse(JSONdata)
var JSONdata = {{years_cocaine|tojson}}
var years_cocaine = JSON.parse(JSONdata)

var JSONdata = {{views|tojson}}    
var views = JSON.parse(JSONdata)
var JSONdata = {{views_cannabis|tojson}}
var views_cannabis = JSON.parse(JSONdata)
var JSONdata = {{views_amphetamines|tojson}}
var views_amphetamines = JSON.parse(JSONdata)
var JSONdata = {{views_lsd|tojson}}
var views_lsd = JSON.parse(JSONdata)
var JSONdata = {{views_mushrooms|tojson}}
var views_mushrooms = JSON.parse(JSONdata)
var JSONdata = {{views_mdma|tojson}}
var views_mdma = JSON.parse(JSONdata)
var JSONdata = {{views_ketamine|tojson}}
var views_ketamine = JSON.parse(JSONdata)
var JSONdata = {{views_cocaine|tojson}}
var views_cocaine = JSON.parse(JSONdata)

function updateSiteData(value){
    if (value == 'aggregate'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views, years, value)
    }
    if (value == 'cannabis'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_cannabis, years_cannabis, value)
    }
    if (value == 'amphetamines'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_amphetamines, years_amphetamines, value)
    }
    if (value == 'LSD'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_lsd, years_lsd, value)
    }
    if (value == 'mushrooms'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_mushrooms, years_mushrooms, value)
    }
    if (value == 'ketamine'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_ketamine, years_ketamine, value)
    }
    if (value == 'cocaine'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_cocaine, years_cocaine, value)
    }
    if (value == 'MDMA'){
      d3.select("#post-count-chart").remove()
      d3.select("#view-count-chart").remove()
      drawBarChart(views_mdma, years_mdma, value)
    }
    if (value == "MDMA" || value == "LSD"){
      document.getElementById('post-title').innerHTML = value + " Forum Posts by Year"; 
      document.getElementById('view-title').innerHTML = value + " Forum Views by Year"; 
    }
    else if (value == "aggregate"){
      document.getElementById('post-title').innerHTML = "Forum Posts by Year" 
      document.getElementById('view-title').innerHTML = "Forum Views by Year"    
    }
    else{
      document.getElementById('post-title').innerHTML = value.charAt(0).toUpperCase() + value.slice(1) +  " Forum Posts by Year" 
      document.getElementById('view-title').innerHTML = value.charAt(0).toUpperCase() + value.slice(1) +  " Forum Views by Year" 
    }
    document.getElementById('bar-chart-dropdown').innerHTML = "Display " + value + " data.";
}
window.onload = updateSiteData('aggregate')


function drawBarChart(viewData, yearData, set){

  var margin = {top: 20, right:0, bottom:30, left:60},
          width = 400 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom

  var svg = d3.select("#post-count-container").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .attr("id", "post-count-chart")

  var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
      y = d3.scaleLinear().rangeRound([height, 0]);

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
  yearData.forEach(function (d) {
        d.year = d.year;
        d.count = +d.count;
      });

  x.domain(yearData.map(function(d) { return d.year; }));
  y.domain([0, d3.max(yearData, function(d) { return d.count; })]);

  g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
          .style("text-anchor","end")
          .attr("dx", "-.5em")
          .attr("dy", ".6em")
          .attr("transform","rotate(-33)")


  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10))
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")

  g.selectAll(".bar")
    .data(yearData)
    .enter().append("rect")
      .attr("id","year-bar-chart")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.year); })
      .attr("y", function(d) { return y(d.count); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.count); })
      .append("title")
        .text(function(d) { return d.year+ ": " + d.count + " forum posts" });;


  var svg = d3.select("#view-count-container").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .attr("id", "view-count-chart")


  var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
      y = d3.scaleLinear().rangeRound([height, 0]);

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
  viewData.forEach(function (d) {
        d.year = d.year;
        d.views = +d.views;
      });

  x.domain(viewData.map(function(d) { return d.year; }));
  y.domain([0, d3.max(viewData, function(d) { return d.views; })]);

  g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
          .style("text-anchor","end")
          .attr("dx", "-.5em")
          .attr("dy", ".6em")
          .attr("transform","rotate(-33)")

  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10))

  g.selectAll(".bar")
    .data(viewData)
    .enter().append("rect")
      .attr("id","view-bar-chart")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.year); })
      .attr("y", function(d) { return y(d.views); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.views); })
      .append("title")
        .text(function(d) { 
            if (d.views > 1.0e+6){
                return d.year+ ": " + Math.round(10*d.views / 1.0e+6)/10 +"M forum views"
            }
            else{
                return d.year+": " + Math.round(10*d.views / 1.0e3)/10+"K forum views"
            }})

}


</script>

<style>

p {
  margin-bottom: .33em;
}

.graphContainer {
  float: left;
}

#year-bar-chart {
  fill: #9B59B6;
  opacity:.75;
}

#year-bar-chart:hover {
  opacity:.9;
}

#view-bar-chart {
  fill: #E74C3C;
  opacity:.75;
}

#view-bar-chart:hover {
  opacity:.9;
}

.axis--x path {
  display: none;
}

.arc path{
    opacity:.75;
}

.arc path:hover {
    opacity:1;
}

.arc text {
  font: 8px sans-serif;
  text-anchor: middle;
}

.arc path {
  stroke: #fff;
}

#buttonContainer{
  padding-left:1em
}
</style>

{% endblock %}
